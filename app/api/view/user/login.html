<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>登录</title>
    {include file="public/_meta" /}
</head>

<body class="layui-card">
    <div style="text-align:center">
        <form class="layui-form layui-card-body">
            <div class="layui-form-item layui-inline">
                <input name="username" type="text" class="layui-form layui-input-inline">
            </div>
            <div class="layui-form-item layui-inline">
                <input name="password" type="password" class="layui-form layui-input-inline">
            </div>
            <div class="layui-form-item layui-inline">
                <button class="layui-btn" lay-submit lay-filter="commit">登录</button>
            </div>
        </form>
    </div>
    <script>
        // 获取api的token
        let token = getApiToken();
        // layui
        layui.use(['form', 'layer'], function () {
            var form = layui.form,
                layer = layui.layer;

            // 是否已登录过
            if (!empty(token)) {
                layer.msg('已登录，无需重复登录', {}, function () {
                    $(window).attr('location', '/api/View/user/index');
                });
            }
            form.on('submit(commit)', function (data) {
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    url: '/api/User/login',
                    data: {
                        username: data.field.username,
                        password: data.field.password
                    },
                    success: function (res) {
                        if (res.status === config('failed')) {
                            layer.msg(res.message);
                        } else if (res.status === config('success')) {
                            layer.msg('登录成功！', {}, function () {
                                $.cookie('api_login_token', res.result, { expires: 100 * 365, path: '/' });
                                $(window).attr('location', '/api/View/user/index');
                            });
                        }
                    }
                });

                return false;
            });
        });
    </script>
</body>

</html>